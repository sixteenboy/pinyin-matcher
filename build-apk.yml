name: ğŸš€ Build Android APK

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º

jobs:
  build:
    name: ğŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: â˜• Install Java 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: ğŸ” Verify Java Installation
      run: |
        echo "éªŒè¯ Java å®‰è£…..."
        java -version
        javac -version
        echo "JAVA_HOME from setup-java: $JAVA_HOME"
        ls -la $JAVA_HOME || echo "JAVA_HOME è·¯å¾„ä¸å­˜åœ¨"

        # å°†æ­£ç¡®çš„ JAVA_HOME ä¿å­˜åˆ°ç¯å¢ƒæ–‡ä»¶
        echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
        echo "æ­£ç¡®çš„ JAVA_HOME å·²ä¿å­˜: $JAVA_HOME"

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          unzip \
          zip \
          libtool \
          libtool-bin \
          autotools-dev \
          automake \
          autoconf \
          pkg-config \
          libffi-dev \
          libssl-dev \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libbz2-dev \
          libreadline-dev \
          libsqlite3-dev \
          libgdbm-dev \
          libdb-dev \
          liblzma-dev \
          uuid-dev

    - name: ğŸ”§ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "å·²å®‰è£…çš„åŒ…ï¼š"
        pip list
        echo "Buildozer ç‰ˆæœ¬ï¼š"
        buildozer version

    - name: ğŸ“± Cache Android SDK
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-${{ runner.os }}-

    - name: ğŸ—ï¸ Build APK
      run: |
        echo "å¼€å§‹æ„å»º APK..."
        echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
        ls -la
        echo "æ£€æŸ¥ buildozer.spec æ–‡ä»¶ï¼š"
        cat buildozer.spec | head -20
        echo "è®¾ç½®æ„å»ºç¯å¢ƒ..."
        export BUILDOZER_LOG_LEVEL=2

        # éªŒè¯ JAVA_HOME ç¯å¢ƒå˜é‡
        echo "æ„å»ºæ—¶ JAVA_HOME: $JAVA_HOME"
        echo "éªŒè¯ Java å¯ç”¨æ€§:"
        java -version
        ls -la "$JAVA_HOME" || echo "JAVA_HOME è·¯å¾„éªŒè¯å¤±è´¥"

        # è®¾ç½® autotools ç¯å¢ƒå˜é‡
        export ACLOCAL_PATH="/usr/share/aclocal:$ACLOCAL_PATH"
        export PKG_CONFIG_PATH="/usr/lib/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH"
        export LIBTOOLIZE=libtoolize
        export AUTORECONF_FLAGS="-fiv"

        # å¼ºåˆ¶é‡æ–°ç”Ÿæˆ autotools ç¼“å­˜
        sudo rm -rf /usr/share/aclocal/libtool.m4 2>/dev/null || true
        sudo apt-get install --reinstall libtool-bin libtool 2>/dev/null || true

        echo "ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ:"
        echo "  JAVA_HOME: $JAVA_HOME"
        echo "  ACLOCAL_PATH: $ACLOCAL_PATH"
        echo "  PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
        echo "æœ€ç»ˆç¯å¢ƒæ£€æŸ¥..."
        echo "PATH: $PATH"
        which java
        which javac
        $JAVA_HOME/bin/java -version || echo "JAVA_HOME/bin/java ä¸å¯ç”¨"

        # åˆ›å»ºç¬¦å·é“¾æ¥ä»¥ç¡®ä¿ buildozer èƒ½æ‰¾åˆ° Java
        if [ ! -d "/usr/lib/jvm/java-8-openjdk-amd64" ] && [ -d "$JAVA_HOME" ]; then
          echo "åˆ›å»º Java ç¬¦å·é“¾æ¥..."
          sudo mkdir -p /usr/lib/jvm
          sudo ln -sf "$JAVA_HOME" /usr/lib/jvm/java-8-openjdk-amd64
          echo "ç¬¦å·é“¾æ¥å·²åˆ›å»º: /usr/lib/jvm/java-8-openjdk-amd64 -> $JAVA_HOME"
        fi

        echo "å¼€å§‹æ„å»º..."
        # å°è¯•ä½¿ç”¨æ›´ç®€å•çš„æ„å»ºæ–¹å¼
        buildozer android debug || {
          echo "æ„å»ºå¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—..."
          if [ -f ".buildozer/android/platform/build-*/build.log" ]; then
            echo "=== æ„å»ºæ—¥å¿— ==="
            tail -100 .buildozer/android/platform/build-*/build.log
          fi
          if [ -f ".buildozer/android/platform/python-for-android/dist/*/build.log" ]; then
            echo "=== Python-for-Android æ—¥å¿— ==="
            tail -100 .buildozer/android/platform/python-for-android/dist/*/build.log
          fi
          exit 1
        }

    - name: ğŸ“‹ List build output
      if: always()
      run: |
        echo "æ£€æŸ¥æ„å»ºè¾“å‡ºï¼š"
        ls -la
        if [ -d "bin" ]; then
          echo "âœ… bin ç›®å½•å†…å®¹ï¼š"
          ls -la bin/
        else
          echo "âŒ bin ç›®å½•ä¸å­˜åœ¨"
        fi
        if [ -d ".buildozer" ]; then
          echo "ğŸ“ .buildozer ç›®å½•å­˜åœ¨"
          echo "æœ€è¿‘çš„æ„å»ºæ—¥å¿—ï¼š"
          find .buildozer -name "*.log" -type f -exec tail -50 {} \; 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"
        else
          echo "âŒ .buildozer ç›®å½•ä¸å­˜åœ¨"
        fi

    - name: ğŸ“¤ Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: pinyin-matcher-apk-${{ github.run_number }}
        path: bin/*.apk
        retention-days: 30

    - name: ğŸ·ï¸ Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        name: æ‹¼éŸ³åŒ¹é…å™¨ ${{ github.ref_name }}
        body: |
          ## ğŸ“± æ‹¼éŸ³åŒ¹é…å™¨ Android APK

          ### ğŸ†• æ–°ç‰ˆæœ¬ç‰¹æ€§
          - è‡ªåŠ¨æ„å»ºçš„ Android APK
          - æ”¯æŒ Android 5.0+ è®¾å¤‡
          - åŒ…å«å®Œæ•´çš„æ‹¼éŸ³æ•°æ®åº“
          - æ™ºèƒ½æ‹¼éŸ³åŒ¹é…åŠŸèƒ½
          - ç§»åŠ¨ç«¯ä¼˜åŒ–ç•Œé¢

          ### ğŸ“¥ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹æ–¹çš„ APK æ–‡ä»¶
          2. åœ¨ Android è®¾å¤‡ä¸Šå…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨
          3. å®‰è£… APK æ–‡ä»¶
          4. äº«å—æ‹¼éŸ³åŒ¹é…åŠŸèƒ½

          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - Python ç‰ˆæœ¬: 3.9
          - Kivy ç‰ˆæœ¬: 2.1.0
          - æ”¯æŒæ¶æ„: ARM64, ARMv7
          - æœ€ä½ Android ç‰ˆæœ¬: 5.0 (API 21)

          ### ğŸ“± åº”ç”¨ç‰¹ç‚¹
          - ğŸ” æ™ºèƒ½æ‹¼éŸ³åŒ¹é…
          - ğŸ“Š å®Œæ•´æ‹¼éŸ³æ•°æ®åº“
          - ğŸ¨ ç°ä»£åŒ–ç§»åŠ¨ç«¯ç•Œé¢
          - ğŸš€ é«˜æ€§èƒ½åŒ¹é…ç®—æ³•
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ’¬ Comment on PR
      if: github.event_name == 'pull_request' && success()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸ‰ APK æ„å»ºæˆåŠŸï¼å¯ä»¥åœ¨ [Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) é¡µé¢ä¸‹è½½æ„å»ºçš„ APK æ–‡ä»¶ã€‚'
          })

    - name: ğŸ§¹ Cleanup old artifacts
      if: github.event_name == 'schedule'
      uses: actions/github-script@v7
      with:
        script: |
          // æ¸…ç†è¶…è¿‡30å¤©çš„æ„å»ºåˆ¶å“
          const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });

          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

          for (const artifact of artifacts.artifacts) {
            if (new Date(artifact.created_at) < thirtyDaysAgo) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
              console.log(`åˆ é™¤æ—§åˆ¶å“: ${artifact.name}`);
            }
          }
