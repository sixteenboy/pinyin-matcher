name: ğŸš€ Build Android APK

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º

jobs:
  build:
    name: ğŸ—ï¸ Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: â˜• Install Java 8
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          unzip \
          zip

    - name: ğŸ”§ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer==1.5.0
        pip install kivy==2.1.0
        pip install cython==0.29.33

    - name: ğŸ“± Cache Android SDK
      uses: actions/cache@v3
      with:
        path: ~/.buildozer
        key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-${{ runner.os }}-

    - name: ğŸ—ï¸ Build APK
      run: |
        echo "å¼€å§‹æ„å»º APK..."
        buildozer android debug

    - name: ğŸ“‹ List build output
      run: |
        echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºæ–‡ä»¶ï¼š"
        ls -la
        if [ -d "bin" ]; then
          echo "bin ç›®å½•å†…å®¹ï¼š"
          ls -la bin/
        else
          echo "âŒ bin ç›®å½•ä¸å­˜åœ¨"
        fi

    - name: ğŸ“¤ Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: pinyin-matcher-apk-${{ github.run_number }}
        path: bin/*.apk
        retention-days: 30

    - name: ğŸ·ï¸ Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        name: æ‹¼éŸ³åŒ¹é…å™¨ ${{ github.ref_name }}
        body: |
          ## ğŸ“± æ‹¼éŸ³åŒ¹é…å™¨ Android APK

          ### ğŸ†• æ–°ç‰ˆæœ¬ç‰¹æ€§
          - è‡ªåŠ¨æ„å»ºçš„ Android APK
          - æ”¯æŒ Android 5.0+ è®¾å¤‡
          - åŒ…å«å®Œæ•´çš„æ‹¼éŸ³æ•°æ®åº“
          - æ™ºèƒ½æ‹¼éŸ³åŒ¹é…åŠŸèƒ½
          - ç§»åŠ¨ç«¯ä¼˜åŒ–ç•Œé¢

          ### ğŸ“¥ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ä¸‹æ–¹çš„ APK æ–‡ä»¶
          2. åœ¨ Android è®¾å¤‡ä¸Šå…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨
          3. å®‰è£… APK æ–‡ä»¶
          4. äº«å—æ‹¼éŸ³åŒ¹é…åŠŸèƒ½

          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - Python ç‰ˆæœ¬: 3.9
          - Kivy ç‰ˆæœ¬: 2.1.0
          - æ”¯æŒæ¶æ„: ARM64, ARMv7
          - æœ€ä½ Android ç‰ˆæœ¬: 5.0 (API 21)

          ### ğŸ“± åº”ç”¨ç‰¹ç‚¹
          - ğŸ” æ™ºèƒ½æ‹¼éŸ³åŒ¹é…
          - ğŸ“Š å®Œæ•´æ‹¼éŸ³æ•°æ®åº“
          - ğŸ¨ ç°ä»£åŒ–ç§»åŠ¨ç«¯ç•Œé¢
          - ğŸš€ é«˜æ€§èƒ½åŒ¹é…ç®—æ³•
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ’¬ Comment on PR
      if: github.event_name == 'pull_request' && success()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸ‰ APK æ„å»ºæˆåŠŸï¼å¯ä»¥åœ¨ [Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) é¡µé¢ä¸‹è½½æ„å»ºçš„ APK æ–‡ä»¶ã€‚'
          })

    - name: ğŸ§¹ Cleanup old artifacts
      if: github.event_name == 'schedule'
      uses: actions/github-script@v6
      with:
        script: |
          // æ¸…ç†è¶…è¿‡30å¤©çš„æ„å»ºåˆ¶å“
          const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });

          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

          for (const artifact of artifacts.artifacts) {
            if (new Date(artifact.created_at) < thirtyDaysAgo) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
              console.log(`åˆ é™¤æ—§åˆ¶å“: ${artifact.name}`);
            }
          }
